---
# Bug: is not idempotent, `get_url` Should only download once! as "force = no"
# https://github.com/ansible/ansible/issues/64016

- name: Create a directory
  become: true
  ansible.builtin.file:
    path: /var/vagrant
    state: directory
    owner: "{{ansible_user}}"

- name: is plugin installed?
  shell: |
    compgen -G "/home/me/.vagrant.d/gems/*/gems/vagrant-libvirt-*/vagrant-libvirt.gemspec"
    if [ $? == 1 ]; then echo False
    elif [ $? == 0 ]; then echo True
    fi
  register: plugin_installed
  changed_when: false
  args:
    executable: /bin/bash


- name: Download vagrant-libvirt-qa install script
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/vagrant-libvirt/vagrant-libvirt-qa/main/scripts/install.bash
    dest: /var/vagrant/install.bash
    force: no
    mode: '0744'
  when: not (plugin_installed.stdout | bool)
# Hack to make idempotent until 'force:' is fixed!

- name: Apply patch
  become: true
  ansible.posix.patch:
    src: Ubuntu-remove-qemu.patch
    dest: /var/vagrant/install.bash

- name: install.bash
  become: true
  ansible.builtin.shell: /var/vagrant/install.bash
  when: not (plugin_installed.stdout | bool)


- debug:
    msg: "{{plugin_installed.stdout}}"

# https://vagrant-libvirt.github.io/vagrant-libvirt/installation.html
